#!/usr/bin/env sh

echo "ğŸ” Running Phase 3 pre-commit checks..."

# Enhanced Git status validation
echo "ğŸ“‹ Git status validation..."
if ! git diff-index --quiet HEAD --; then
    echo "âŒ ERROR: Uncommitted changes detected during pre-commit!"
    echo "This should not happen - investigating..."
    git status --porcelain
    # Don't fail here as this is expected during commit process
fi

# Check for untracked files that might need attention
UNTRACKED_FILES=$(git ls-files --others --exclude-standard | head -10)
if [ -n "$UNTRACKED_FILES" ]; then
    echo "ğŸ“‹ Untracked files detected:"
    echo "$UNTRACKED_FILES"
    echo "ğŸ’¡ Consider adding to .gitignore if these are not needed"
fi

# Run critical linting (ESLint errors only - warnings are non-blocking)
echo "ğŸ“‹ ESLint critical check..."
npm run lint:clean > /tmp/eslint.log 2>&1
EXIT_CODE=$?
if [ "$EXIT_CODE" -eq 2 ]; then
    echo "âŒ ESLint critical errors found!"
    cat /tmp/eslint.log
    exit 1
fi
echo "âœ… ESLint: No critical errors (warnings allowed)"

# Run tests to ensure changes don't break functionality
echo "ğŸ§ª Running infrastructure tests..."
npm test || exit 1

# Check for critical Python issues (undefined names only - E999 was deprecated)
echo "ğŸ Python critical checks..."
if command -v ruff >/dev/null 2>&1; then
    ruff check . --select F821 > /tmp/ruff.log 2>&1
    if [ $? -ne 0 ]; then
        echo "âŒ Critical Python violations found!"
        cat /tmp/ruff.log
        exit 1
    fi
    echo "âœ… Python: No critical violations (F821)"
else
    echo "âš ï¸ Ruff not available - skipping Python checks"
fi

# Security audit (critical only)
echo "ğŸ”’ Security audit..."
npm audit --audit-level=critical > /tmp/audit.log 2>&1
if [ $? -ne 0 ]; then
    echo "âŒ Critical security vulnerabilities found!"
    cat /tmp/audit.log
    exit 1
fi
echo "âœ… Security: No critical vulnerabilities"

# Final Git status reminder
echo "ğŸ“‹ Final validation reminder..."
echo "ğŸ’¡ Remember to push your committed changes to the remote repository"
echo "ğŸ’¡ Use: git push origin $(git branch --show-current)"

echo "ğŸ¯ Phase 3 pre-commit checks completed successfully!"
echo "ğŸ“Š Quality: ESLint warnings allowed, critical issues blocked"