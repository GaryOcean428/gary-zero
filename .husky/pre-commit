#!/usr/bin/env sh

echo "ğŸ” Running Phase 3 pre-commit checks..."

# Run critical linting (ESLint errors only - warnings are non-blocking)
echo "ğŸ“‹ ESLint critical check..."
npm run lint:clean > /tmp/eslint.log 2>&1
EXIT_CODE=$?
if [ "$EXIT_CODE" -eq 2 ]; then
    echo "âŒ ESLint critical errors found!"
    cat /tmp/eslint.log
    exit 1
fi
echo "âœ… ESLint: No critical errors (warnings allowed)"

# Run tests to ensure changes don't break functionality
echo "ğŸ§ª Running infrastructure tests..."
npm test || exit 1

# Check for critical Python issues (undefined names only - E999 was deprecated)
echo "ğŸ Python critical checks..."
if command -v ruff >/dev/null 2>&1; then
    ruff check . --select F821 > /tmp/ruff.log 2>&1
    if [ $? -ne 0 ]; then
        echo "âŒ Critical Python violations found!"
        cat /tmp/ruff.log
        exit 1
    fi
    echo "âœ… Python: No critical violations (F821)"
else
    echo "âš ï¸ Ruff not available - skipping Python checks"
fi

# Security audit (critical only)
echo "ğŸ”’ Security audit..."
npm audit --audit-level=critical > /tmp/audit.log 2>&1
if [ $? -ne 0 ]; then
    echo "âŒ Critical security vulnerabilities found!"
    cat /tmp/audit.log
    exit 1
fi
echo "âœ… Security: No critical vulnerabilities"

echo "ğŸ¯ Phase 3 pre-commit checks completed successfully!"
echo "ğŸ“Š Quality: ESLint warnings allowed, critical issues blocked"