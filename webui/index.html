<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Gary-Zero</title>
    <script>
        // Expose newChat function early for Alpine.js
        window.newChat = function() {
            if (window.safeCall) {
                window.safeCall('newChat');
            }
        };

        // Expose handleFileUploadForAlpine early for Alpine.js
        window.handleFileUploadForAlpine = function(event) {
            console.log('File upload function called early, will be replaced when index.js loads');
            // This is a placeholder that will be replaced when index.js loads
        };
    </script>
    {{feature_flags_config}}
    <style>
        /* Screen reader only text */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Enhanced focus indicators for accessibility */
        button:focus-visible,
        input:focus-visible,
        textarea:focus-visible,
        select:focus-visible,
        a:focus-visible {
            outline: 2px solid var(--color-primary, #3b82f6);
            outline-offset: 2px;
            border-radius: 4px;
        }

        /* Better disabled state */
        button:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }

        /* Validation states */
        .validation-error {
            color: var(--color-error, #ef4444);
            font-size: 0.875rem;
            margin-top: 4px;
            display: none;
        }

        input[aria-invalid="true"],
        textarea[aria-invalid="true"] {
            border-color: var(--color-error, #ef4444) !important;
            box-shadow: 0 0 0 1px var(--color-error, #ef4444);
        }

        input[aria-invalid="false"],
        textarea[aria-invalid="false"] {
            border-color: var(--color-success, #10b981);
        }
    </style>

    <link rel="icon" type="image/svg+xml" href="public/favicon.svg">
    <link rel="stylesheet" href="css/inline-styles.css">
    <link rel="stylesheet" href="index.css">
    <link rel="stylesheet" href="css/toast.css">
    <link rel="stylesheet" href="css/settings.css">
    <link rel="stylesheet" href="css/file_browser.css">
    <link rel="stylesheet" href="css/modals.css">
    <link rel="stylesheet" href="css/modals2.css">
    <link rel="stylesheet" href="css/speech.css">
    <link rel="stylesheet" href="css/history.css">
    <link rel="stylesheet" href="css/scheduler-datepicker.css">
    <link rel="stylesheet" href="css/tunnel.css">

    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <!-- Flatpickr for datetime picker -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <script>
        window.safeCall = function (name, ...args) {
            if (window[name]) window[name](...args)
        }
    </script>

    <!-- Pre-initialize schedulerSettings to ensure Alpine doesn't miss it -->
    <script>
        // Pre-define schedulerSettings skeleton to ensure it's available to Alpine
        window.schedulerSettings = function() {
            return {
                tasks: [],
                selected: '',
                openTaskDetail(taskId) {
                    window.openTaskDetail(taskId);
                }
            };
        };

    </script>

    <!-- CSP and Alpine.js compatibility fix - load early -->
    <script type="text/javascript" src="js/csp-alpine-fix.js"></script>
    
    <!-- Error reporting - load before error boundary -->
    <script type="text/javascript" src="js/error-reporting.js"></script>
    
    <!-- Error boundary - load early to catch all errors -->
    <script type="text/javascript" src="js/error-boundary.js"></script>

    <!-- Load Alpine.js first -->
    <script defer type="module" src="js/initFw.js"></script>

    <!-- VS Code Web Integration - Only load in development -->
    <script>
        // Conditionally load VS Code integration only if not in production
        const isProduction = window.location.hostname.includes('railway.app') || 
                           window.location.hostname.includes('herokuapp.com') || 
                           window.location.hostname.includes('vercel.app') || 
                           window.location.hostname.includes('netlify.app');
        
        const devFeaturesEnabled = window.ENABLE_DEV_FEATURES !== false;
        const vscodeIntegrationEnabled = window.VSCODE_INTEGRATION_ENABLED !== false;
        
        if (!isProduction && devFeaturesEnabled && vscodeIntegrationEnabled) {
            const script = document.createElement('script');
            script.type = 'module';
            script.src = 'js/vscode-integration.js';
            document.head.appendChild(script);
            console.log('üîß VS Code integration enabled in development mode');
        } else {
            console.log('‚ÑπÔ∏è  VS Code integration disabled in production mode');
        }
    </script>

    <!-- Then load module scripts with defer to ensure DOM is ready -->
    <script defer type="module" src="js/scheduler.js"></script>
    <script defer type="module" src="js/speech.js"></script>
    <script defer type="module" src="js/history.js"></script>

    <script type="module" src="js/ui-init.js"></script>
    <script type="module" src="index.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/ace-builds@1.36.5/src-noconflict/ace.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/ace-builds@1.36.5/css/ace.min.css" rel="stylesheet">
    <!-- KaTeX CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css" crossorigin="anonymous">

    <!-- KaTeX javascript -->
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js"
        crossorigin="anonymous"></script>

    <!-- Non-module scripts after Alpine.js -->
    <script type="text/javascript" src="js/dom-helpers.js"></script>
    <script type="text/javascript" src="js/enhanced-ux.js"></script>
    <script type="text/javascript" src="js/chat-input-autoresize.js"></script>
    <script type="text/javascript" src="js/settings.js"></script>
    <script type="text/javascript" src="js/tunnel.js"></script>
    <script type="text/javascript" src="js/file_browser.js"></script>
    <script type="text/javascript" src="js/modal.js"></script>
    <script type="text/javascript" src="js/sidebar-tabs.js"></script>
    <script type="text/javascript" src="js/activity-monitor.js"></script>
    <script type="text/javascript" src="js/shell-iframe.js"></script>
    <script type="text/javascript" src="js/ai-action-visualization.js"></script>
</head>

<body class="dark-mode">
    <div class="container">
        <div id="sidebar-overlay" class="sidebar-overlay hidden"></div>
        <div class="icons-section" id="hide-button" x-data="{ connected: true }">
            <!--Sidebar-->
            <!-- Sidebar Toggle Button -->
            <button id="toggle-sidebar" class="toggle-sidebar-button" aria-label="Toggle Sidebar" aria-expanded="false">
                <span aria-hidden="true">
                    <!-- Hamburger Icon -->
                    <svg id="sidebar-hamburger-svg" xmlns="http://www.w3.org/2000/svg" width="22" height="22"
                        viewBox="0 0 24 24" fill="CurrentColor">
                        <path d="M3 13h18v-2H3v2zm0 4h18v-2H3v2zm0-8h18V7H3v2z"></path>
                    </svg>
                </span>
            </button>

            <div id="logo-container">
                <a href="https://github.com/frdel/gary-zero" target="_blank" rel="noopener noreferrer">
                    <img src="./public/splash.jpg" alt="Gary-Zero Logo" width="32" height="32">
                    <span class="brand-text">Gary-Zero</span>
                </a>
            </div>
        </div>

        <div id="left-panel" class="panel">
            <!--Sidebar upper elements-->
            <div class="left-panel-top">
                <div class="config-section" x-data="{ showQuickActions: true }">
                    <button class="config-button" id="reset-chat" @click="resetChat()">Reset Chat</button>
                    <button class="config-button" id="new-chat" @click="newChat()">New Chat</button>
                    <button class="config-button" id="load-chats" @click="loadChats()">Load Chat</button>
                    <button class="config-button" id="save-chat" @click="saveChat()">Save Chat</button>
                    <button class="config-button" id="restart" @click="restart()">Restart</button>
                    <button class="config-button" id="settings" @click="settingsModalProxy.openModal()"><svg
                            xmlns="http://www.w3.org/2000/svg" version="1.1" viewBox="-5.0 -17.0 110.0 135.0"
                            fill="currentColor" width="24" height="24">
                            <path
                                d="m52.301 90.102h-4.1016c-3 0-5 0-6.8984-1.3984-1.8984-1.3984-2.5-3.3008-3.5-6.1016l-1.1016-3.6016c-0.19922-0.60156-0.69922-1.1992-1.3984-1.6016l-1.1016-0.60156c-0.60156-0.30078-1.5-0.39844-2.3008-0.19922l-4.3008 1.1992c-3.1016 0.89844-5.1016 1.5-7.3984 0.5-2.3008-0.89844-3.3984-2.8008-5-5.6016l-1.8008-3.1016c-1.5-2.5-2.5-4.3008-2.3008-6.6992 0.19922-2.3984 1.6016-3.8008 3.6016-6.1016l3.8008-4.1992c0.19922-0.19922 0.60156-1.3984 0.60156-2.6016 0 1.1016 0.5 2.3008 0.80078 2.6992l3.6016 4c2 2.1992 3.3008 3.6992 3.6016 6.1016 0.19922 2.3984-0.80078 4.1992-2.3008 6.6992l-1.8008 3.1016c-1.6016 2.8008-2.6992 4.6016-5 5.6016-2.3008 0.89844-4.3984 0.39844-7.3984-0.5l-4.3984-1.1992c-0.69922-0.10156-1.5 0-2.3008 0.30078l-1.1016 0.60156c-0.5 0.30078-1 0.89844-1.3008 1.6992l-1.1992 3.5c-0.89844 2.8008-1.6016 4.6992-3.5 6.1016-1.8008 1.293-3.8008 1.293-6.8008 1.293zm-6.6016-7.3008c0.5 0.10156 1.6016 0.10156 2.6016 0.10156h4.1016c1 0 2 0 2.6016-0.10156 0.19922-0.5 0.60156-1.5 0.89844-2.3984l1.1992-3.6016c0.89844-2.3008 2.3984-4.1992 4.3984-5.3984l1.3984-0.80078c2.3984-1.3008 5.1016-1.6016 7.6016-1l4.6016 1.3008c1 0.30078 2.1016 0.60156 2.6992 0.69922 0.30078-0.5 0.89844-1.5 1.3984-2.3984l1.8008-3.1016c-0.30078-0.39844-1-1.1992-1.6992-2l-3.8008-4.1992c-1.6016-2-2.5-4.8008-2.5-7.3984 0-2.6016 0.89844-5.3984 2.3008-7.3008l3.8984-4.3984c0.69922-0.69922 1.3984-1.5 1.6992-2 0.19922-0.5 0.80078-1.3984 1.1992-2.3008l1.8008-3.1016c0.5-0.89844 1.1016-1.8984 1.3984-2.3984 0.60156 0.10156 1.6992-0.39844 2.6992-0.69922l4.3984-1.1992c2.6992-0.60156 5.3008-0.30078 7.6016 0.89844l1.3984 0.80078c2.1016 1.3008 3.6016 3.1992 4.3984 5.3984l1.3008 3.8008c0.5 0.80078 0.80078 1.8008 1 2.3008z">
                            </path>
                            <path
                                d="m50.301 66.5c-9 0-16.398-7.3008-16.398-16.398 0-9.1016 7.3008-16.398 16.398-16.398 9.1016 0 16.398 7.3008 16.398 16.398 0 9.0977-7.3984 16.398-16.398 16.398zm0-25.5c-5 0-9.1016 4.1016-9.1016 9.1016s4.1016 9.1016 9.1016 9.1016 9.1016-4.1016 9.1016-9.1016c-0.003906-5-4.1016-9.1016-9.1016-9.1016z">
                            </path>
                        </svg>Settings</button>

                </div>

                <!-- Tabs container -->
                <div class="tabs-container">
                    <div class="tabs">
                        <div class="tab active" id="chats-tab">Chats</div>
                        <div class="tab" id="tasks-tab">Tasks</div>
                    </div>
                </div>

                <!-- Chats List -->
                <div class="config-section" id="chats-section" x-data="{ contexts: [], selected: '' }"
                    x-show="contexts.length > 0 || true">
                    <div class="chats-list-container">
                        <ul class="config-list" x-show="contexts.length > 0">
                            <template x-for="context in contexts">
                                <li>
                                    <div :class="{'chat-list-button': true, 'font-bold': context.id === selected}"
                                        @click="selected = context.id; selectChat(context.id)">
                                        <span class="chat-name" :title="context.name ? context.name : 'Chat #' + context.no"
                                            x-text="context.name ? context.name : 'Chat #' + context.no"></span>
                                    </div>
                                                    <button class="edit-button" @click="killChat(context.id)">X</button>
                                </li>
                            </template>
                        </ul>
                        <div class="empty-list-message" x-show="contexts.length === 0">
                            <p>Start a new conversation to see your chat history here.</p>
                        </div>
                    </div>
                </div>

                <!-- Tasks List -->
                <div class="config-section" id="tasks-section" x-data="{
                    tasks: [],
                    selected: '',
                    openTaskDetail(taskId) {
                        window.openTaskDetail(taskId);
                    }
                }">
                    <div class="tasks-list-container">
                        <ul class="config-list" x-show="tasks.length > 0">
                            <template x-for="task in tasks">
                                <li>
                                    <div :class="{'chat-list-button': true, 'font-bold': task.id === selected, 'has-task-container': true}"
                                        @click="selected = task.id; selectChat(task.id)">
                                        <!-- Task container with a vertical layout -->
                                        <div class="task-container task-container-vertical">
                                            <!-- Task name on its own line with full width -->
                                            <span class="task-name" :title="(task.task_name || `Task #${task.no}`) + ' (' + (task.name || `Chat #${task.no}`) + ')'"
                                                x-text="(task.task_name || `Task #${task.no}`) + ' (' + (task.name || `Chat #${task.no}`) + ')'"
                                                :data-task-id="task.id"></span>
                                            <!-- Second line with status badge and action button -->
                                            <div class="task-info-line">
                                                <!-- Status badge (reusing scheduler styling) -->
                                                <span class="scheduler-status-badge scheduler-status-badge-small"
                                                      :class="task.state ? `scheduler-status-${task.state}` : 'scheduler-status-idle'"
                                                      x-text="task.state || 'idle'"></span>
                                                <!-- Action buttons -->
                                                <button class="edit-button"
                                                    @click.stop="openTaskDetail(task.id)"
                                                    title="View task details" style="margin-left: auto; margin-right: 5px;">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 512 512" fill="var(--color-primary)" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <path d="M256 0c70.69 0 134.69 28.66 181.02 74.98C483.34 121.3 512 185.31 512 256c0 70.69-28.66 134.7-74.98 181.02C390.69 483.34 326.69 512 256 512c-70.69 0-134.69-28.66-181.02-74.98C28.66 390.69 0 326.69 0 256c0-70.69 28.66-134.69 74.98-181.02C121.31 28.66 185.31 0 256 0zm-9.96 161.03c0-4.28.76-8.26 2.27-11.91 1.5-3.63 3.77-6.94 6.79-9.91 3-2.95 6.29-5.2 9.84-6.7 3.57-1.5 7.41-2.28 11.52-2.28 4.12 0 7.96.78 11.49 2.27 3.54 1.51 6.78 3.76 9.75 6.73 2.95 2.97 5.16 6.26 6.64 9.91 1.49 3.63 2.22 7.61 2.22 11.89 0 4.17-.73 8.08-2.21 11.69-1.48 3.6-3.68 6.94-6.65 9.97-2.94 3.03-6.18 5.32-9.72 6.84-3.54 1.51-7.38 2.29-11.52 2.29-4.22 0-8.14-.76-11.75-2.26-3.58-1.51-6.86-3.79-9.83-6.79-2.94-3.02-5.16-6.34-6.63-9.97-1.48-3.62-2.21-7.54-2.21-11.77zm13.4 178.16c-1.11 3.97-3.35 11.76 3.3 11.76 1.44 0 3.27-.81 5.46-2.4 2.37-1.71 5.09-4.31 8.13-7.75 3.09-3.5 6.32-7.65 9.67-12.42 3.33-4.76 6.84-10.22 10.49-16.31.37-.65 1.23-.87 1.89-.48l12.36 9.18c.6.43.73 1.25.35 1.86-5.69 9.88-11.44 18.51-17.26 25.88-5.85 7.41-11.79 13.57-17.8 18.43l-.1.06c-6.02 4.88-12.19 8.55-18.51 11.01-17.58 6.81-45.36 5.7-53.32-14.83-5.02-12.96-.9-27.69 3.06-40.37l19.96-60.44c1.28-4.58 2.89-9.62 3.47-14.33.97-7.87-2.49-12.96-11.06-12.96h-17.45c-.76 0-1.38-.62-1.38-1.38l.08-.48 4.58-16.68c.16-.62.73-1.04 1.35-1.02l89.12-2.79c.76-.03 1.41.57 1.44 1.33l-.07.43-37.76 124.7zm158.3-244.93c-41.39-41.39-98.58-67-161.74-67-63.16 0-120.35 25.61-161.74 67-41.39 41.39-67 98.58-67 161.74 0 63.16 25.61 120.35 67 161.74 67 63.16 0 120.35-25.61 161.74-67 41.39-41.39 67-98.58 67-161.74 0-63.16-25.61-120.35-67-161.74z"></path>
                                                        <path d="m113.8,2.42L74.45,51.53c-4.71,6.68,3.2,11.91,8.39,5.64l39.2-49.27 C125.12,1.86,119.13-3.16,113.8,2.42L113.8,2.42z"></path>
                                                    </svg>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </li>
                            </template>
                        </ul>
                        <div class="empty-list-message" x-show="tasks.length === 0">
                            <p>Start a new conversation to see your task history here.</p>
                        </div>
                    </div>
                </div>

                    <!-- Preferences -->
                    <div class="pref-section" x-data="{ prefOpen: true }">
                        <span>
                            <h3 class="pref-header" @click="prefOpen = !prefOpen">
                                Preferences
                                <svg class="arrow-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                                    stroke="currentColor" stroke-width="2" width="16" height="16"
                                    :class="{'rotated': !prefOpen}">
                                    <path d="M8 4l8 8-8 8" />
                                </svg>
                            </h3>
                            <ul class="config-list" id="pref-list-desktop" x-show="prefOpen" x-collapse x-transition>
                                <!-- Preferences Items -->
                                <li x-data="{ autoScroll: true }">
                                    <span>Autoscroll</span>
                                    <label class="switch">
                                        <input id="auto-scroll-switch" type="checkbox" x-model="autoScroll"
                                            x-effect="window.safeCall('toggleAutoScroll',autoScroll)" aria-label="Toggle autoscroll">
                                        <span class="slider"></span>
                                    </label>
                                </li>
                                <li x-data="{ darkMode: localStorage.getItem('darkMode') != 'false' }"
                                    x-init="$watch('darkMode', val => toggleDarkMode(val))">
                                    <span class="switch-label">Dark mode</span>
                                    <label class="switch">
                                        <input type="checkbox" x-model="darkMode" aria-label="Toggle dark mode">
                                        <span class="slider"></span>
                                    </label>
                                </li>
                                <li x-data="{ speech: localStorage.getItem('speech') == 'true' }"
                                    x-init="$watch('speech', val => toggleSpeech(val))">
                                    <span class="switch-label">Speech</span>
                                    <label class="switch">
                                        <input type="checkbox" x-model="speech" aria-label="Toggle speech">
                                        <span class="slider"></span>
                                    </label>
                                </li>
                                <li x-data="{ showThoughts: localStorage.getItem('showThoughts') !== 'false' }"
                                    x-init="$watch('showThoughts', val => { localStorage.setItem('showThoughts', val); window.safeCall('toggleThoughts', val); })">
                                    <span>Show thoughts</span>
                                    <label class="switch">
                                        <input type="checkbox" x-model="showThoughts"
                                            x-effect="window.safeCall('toggleThoughts',showThoughts)" aria-label="Toggle show thoughts">
                                        <span class="slider"></span>
                                    </label>
                                </li>
                                <li x-data="{ showJson: localStorage.getItem('showJson') === 'true' }"
                                    x-init="$watch('showJson', val => { localStorage.setItem('showJson', val); window.safeCall('toggleJson', val); })">
                                    <span>Show JSON</span>
                                    <label class="switch">
                                        <input type="checkbox" x-model="showJson"
                                            x-effect="window.safeCall('toggleJson',showJson)" aria-label="Toggle show JSON">
                                        <span class="slider"></span>
                                    </label>
                                </li>
                                <li x-data="{ showUtils: localStorage.getItem('showUtils') === 'true' }"
                                    x-init="$watch('showUtils', val => { localStorage.setItem('showUtils', val); window.safeCall('toggleUtils', val); })">
                                    <span>Show utility messages</span>
                                    <label class="switch">
                                        <input type="checkbox" x-model="showUtils"
                                            x-effect="window.safeCall('toggleUtils',showUtils)" aria-label="Toggle show utility messages">
                                        <span class="slider"></span>
                                    </label>
                                </li>
                            </ul>
                        </span>
                    <!-- Version Info -->
                    <div class="version-info">
                        <span id="a0version-desktop">Version {{version_no}} {{version_time}}</span>
                    </div>
                </div>
            </div>
            <!--Sidebar lower elements-->
            <div class="left-panel-bottom">
                <!-- Version Info -->
                <div class="version-info">
                    <span id="a0version-mobile">Version {{version_no}} {{version_time}}</span>
                </div>
            </div>
        </div>

        <!-- Right Panel - Main Chat Interface -->
        <div id="right-panel" class="panel expanded">
            <!-- Time/Date display -->
            <div id="time-date-container">
                <div id="time-date" x-data="{
                    time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                    date: new Date().toLocaleDateString()
                }" x-init="setInterval(() => {
                    const now = new Date();
                    time = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    date = now.toLocaleDateString();
                }, 1000)">
                    <span id="current-time" x-text="time"></span>
                </div>
                <div id="user-date-display" x-data="{ date: new Date().toLocaleDateString() }" x-init="setInterval(() => {
                    date = new Date().toLocaleDateString();
                }, 60000)">
                    <span x-text="date"></span>
                </div>
            </div>

            <!-- Chat History -->
            <div id="chat-history"
                 x-data="{
                    messages: [],
                    isAtBottom: true,
                    checkScroll() {
                        const element = this.$el;
                        this.isAtBottom = element.scrollHeight - element.clientHeight <= element.scrollTop + 1;
                    }
                 }"
                 @scroll="checkScroll()"
                 aria-live="polite"
                 aria-label="Chat conversation">
                <div class="welcome-message">
                    <h2>Welcome to Gary-Zero</h2>
                    <p>Start a conversation by typing in the input field below.</p>
                </div>
            </div>

            <!-- Input Section -->
            <div id="input-section">
                <!-- Progress Bar -->
                <div id="progress-bar" class="progress-bar" style="display: none;">
                    <div class="progress-fill"></div>
                </div>

                <!-- File Upload Area -->
                <div id="input-attachments-display"
                     x-data="{
                        files: [],
                        addFile(file) {
                            this.files.push({
                                name: file.name,
                                size: file.size,
                                type: file.type,
                                file: file
                            });
                        },
                        removeFile(index) {
                            this.files.splice(index, 1);
                        }
                     }"
                     x-show="files.length > 0"
                     class="attachments-display">
                    <div class="attachments-list">
                        <template x-for="(file, index) in files" :key="index">
                            <div class="attachment-item">
                                <span class="attachment-name" x-text="file.name"></span>
                                <span class="attachment-size" x-text="(file.size / 1024).toFixed(1) + ' KB'"></span>
                                <button class="attachment-remove" @click="removeFile(index)" aria-label="Remove file">√ó</button>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Chat Input Container -->
                <div class="chat-input-container">
                    <!-- File Upload Button -->
                    <button id="file-upload-button" class="file-upload-button" aria-label="Upload file">
                        <input type="file" id="file-input" multiple accept="*/*" @change="handleFileUploadForAlpine($event)" style="display: none;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66L9.2 16.63a2 2 0 0 1-2.83-2.83l8.49-8.49"></path>
                        </svg>
                    </button>

                    <!-- Text Input -->
                    <textarea id="chat-input"
                              placeholder="Type your message here..."
                              rows="1"
                              maxlength="8000"
                              data-validation-rules="[{&quot;type&quot;: &quot;maxLength&quot;, &quot;value&quot;: 8000, &quot;message&quot;: &quot;Message too long&quot;}]"
                              aria-label="Chat message input"
                              aria-describedby="char-count"></textarea>

                    <!-- Character Count -->
                    <div id="char-count" class="char-count" style="display: none;">
                        <span id="char-count-text">0/8000</span>
                    </div>

                    <!-- Chat Buttons -->
                    <div id="chat-buttons-wrapper" class="chat-buttons">
                        <!-- Send Button -->
                        <button id="send-button" class="chat-button" disabled aria-label="Send message">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" width="20" height="20">
                                <path d="M25 20 L75 50 L25 80" fill="none" stroke="currentColor" stroke-width="15" stroke-linecap="round" stroke-linejoin="round"></path>
                            </svg>
                        </button>

                        <!-- Voice Input Button -->
                        <button id="voice-button" class="chat-button voice-button" aria-label="Voice input" style="display: none;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="m12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0v-8a3 3 0 0 0-3-3z"></path>
                                <path d="m19 10v2a7 7 0 0 1-14 0v-2"></path>
                                <line x1="12" y1="19" x2="12" y2="23"></line>
                                <line x1="8" y1="23" x2="16" y2="23"></line>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Activity Monitor Section -->
            <div id="activity-monitor-section" 
                 x-data="{
                    isVisible: false,
                    isLoading: false,
                    activityCount: 0,
                    currentSrc: './activity-monitor.html',
                    
                    async toggleMonitor() {
                        this.isVisible = !this.isVisible;
                        if (this.isVisible) {
                            this.refreshActivityFrame();
                        }
                    },
                    
                    async refreshActivityFrame() {
                        this.isLoading = true;
                        // Force iframe reload by changing src
                        const timestamp = Date.now();
                        this.currentSrc = './activity-monitor.html?t=' + timestamp;
                        setTimeout(() => {
                            this.isLoading = false;
                        }, 1000);
                    },
                    
                    async loadExternalUrl() {
                        const url = prompt('Enter URL to load in activity monitor:');
                        if (url) {
                            try {
                                await fetch('/activity_monitor', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({
                                        action: 'set_iframe_src',
                                        src: url
                                    })
                                });
                                this.currentSrc = url;
                            } catch (error) {
                                console.error('Failed to set iframe source:', error);
                                alert('Failed to load URL');
                            }
                        }
                    }
                 }"
                 class="activity-monitor-section">
                
                <!-- Activity Monitor Toggle Button -->
                <div class="activity-monitor-header">
                    <button @click="toggleMonitor()" 
                            class="activity-monitor-toggle"
                            :class="{ 'active': isVisible }"
                            aria-label="Toggle Activity Monitor">
                        <span class="toggle-icon">üì∫</span>
                        <span class="toggle-text">Live Activity Monitor</span>
                        <span class="activity-indicator" x-show="activityCount > 0" x-text="activityCount"></span>
                        <span class="chevron" :class="{ 'rotated': isVisible }">‚ñº</span>
                    </button>
                </div>
                
                <!-- Activity Monitor Content -->
                <div x-show="isVisible" 
                     x-transition:enter="transition ease-out duration-300"
                     x-transition:enter-start="opacity-0 max-h-0"
                     x-transition:enter-end="opacity-100 max-h-96"
                     x-transition:leave="transition ease-in duration-300"
                     x-transition:leave-start="opacity-100 max-h-96"
                     x-transition:leave-end="opacity-0 max-h-0"
                     class="activity-monitor-content">
                    
                    <!-- Monitor Controls -->
                    <div class="activity-monitor-controls">
                        <button @click="refreshActivityFrame()" 
                                class="monitor-btn"
                                :disabled="isLoading"
                                title="Refresh activity monitor">
                            <span x-show="!isLoading">üîÑ</span>
                            <span x-show="isLoading" class="loading-spinner">‚è≥</span>
                            Refresh
                        </button>
                        
                        <button @click="currentSrc = './activity-monitor.html'" 
                                class="monitor-btn"
                                title="Show activity monitor">
                            üìä Activities
                        </button>
                        
                        <button @click="loadExternalUrl()" 
                                class="monitor-btn"
                                title="Load external URL">
                            üåê Load URL
                        </button>
                        
                        <button @click="currentSrc = 'about:blank'" 
                                class="monitor-btn"
                                title="Clear display">
                            ‚úñÔ∏è Clear
                        </button>
                    </div>
                    
                    <!-- Activity Monitor Iframe -->
                    <div class="activity-monitor-frame-container">
                        <iframe :src="currentSrc"
                                class="activity-monitor-frame"
                                frameborder="0"
                                sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-modals"
                                loading="lazy"
                                title="Live Activity Monitor"
                                @load="isLoading = false">
                        </iframe>
                        
                        <div x-show="isLoading" class="iframe-loading-overlay">
                            <div class="loading-content">
                                <div class="loading-spinner-large">‚è≥</div>
                                <p>Loading activity monitor...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Status Section -->
            <div id="status-section" class="status-section">
                <div id="status-message" class="status-message">Ready</div>
                <div class="status-indicators">
                    <div id="connection-status" class="connection-status connected" title="Connection status">‚óè</div>
                    <div id="model-indicator" class="model-indicator" 
                         :title="'Current model: ' + (currentModel.display_name || 'Loading...')"
                         x-text="currentModel.model_label || 'Loading...'"
                         x-data="{ currentModel: { model_label: 'Loading...', display_name: 'Loading...' } }"
                         x-init="fetchCurrentModel()">
                        Loading...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>

    <div id="settingsModal" x-data="settingsModalProxy">
        <template x-teleport="body">
            <div x-show="isOpen" class="modal-overlay" @click.self="handleCancel()"
                @keydown.escape.window="handleCancel()" x-transition="">
                <div class="modal-container">
                    <div class="modal-header">
                        <h2 x-text="settings.title"></h2>
                        <button class="modal-close" @click="handleCancel()">&times;</button>
                    </div>

                    <div class="modal-content">
                        <!-- Tab Navigation -->
                        <div class="settings-tabs-container">
                            <div class="settings-tabs">
                                <div class="settings-tab"
                                     :class="{'active': activeTab === 'agent'}"
                                     @click="switchTab('agent')"
                                     title="Agent Settings">Agent Settings</div>
                                <div class="settings-tab"
                                     :class="{'active': activeTab === 'external'}"
                                     @click="switchTab('external')"
                                     title="External Services">External Services</div>
                                <div class="settings-tab"
                                     :class="{'active': activeTab === 'mcp'}"
                                     @click="switchTab('mcp')"
                                     title="MCP">MCP</div>
                                <div class="settings-tab"
                                     :class="{'active': activeTab === 'developer'}"
                                     @click="switchTab('developer')"
                                     title="Developer">Developer</div>
                                <div class="settings-tab"
                                     :class="{'active': activeTab === 'scheduler'}"
                                     @click="switchTab('scheduler')"
                                     title="Task Scheduler">Task Scheduler</div>
                            </div>
                        </div>

                        <!-- Display settings sections for agent, external, developer tabs -->
                        <div id="settings-sections" x-show="activeTab !== 'scheduler'">
                            <nav>
                                <ul>
                                    <template x-for="(section, index) in filteredSections" :key="section.title">
                                        <li>
                                            <a :href="'#section' + (index + 1)">
                                <img :src="'/public/' + section.id +'.svg'"
                                    :alt="section.title" width="50" height="50">
                                                <span x-text="section.title"></span>
                                            </a>
                                        </li>
                                    </template>
                                    <!-- Tunnel navigation entry - only visible in the External Services tab -->
                                    <li x-show="activeTab === 'external'">
                                        <a href="#section-tunnel">
                                            <img src="/public/tunnel.svg" alt="Tunnel" width="50" height="50">
                                            <span>Flare Tunnel</span>
                                        </a>
                                    </li>
                                </ul>
                            </nav>

                            <template x-for="(section, sectionIndex) in filteredSections" :key="sectionIndex">
                                <div :id="'section' + (sectionIndex + 1)" class="section">
                                    <div class="section-title" x-text="section.title"></div>
                                    <div class="section-description" x-html="section.description"></div>

                                    <template x-for="(field, fieldIndex) in section.fields.filter(f => !f.hidden)" :key="fieldIndex">
                                        <div :class="{'field': true, 'field-full': field.type === 'textarea'}">
                                            <div class="field-label">
                                                <div class="field-title" x-text="field.title"></div>
                                                <div class="field-description" x-html="field.description || ''"></div>
                                            </div>

                                            <div class="field-control">
                                                <!-- Input field -->
                                                <template x-if="field.type === 'text'">
                                                    <input type="text" :class="field.classes" :value="field.value"
                                                        :readonly="field.readonly === true"
                                                        @input="field.value = $event.target.value">
                                                </template>

                                                <!-- Number field -->
                                                <template x-if="field.type === 'number'">
                                                    <input type="number" :class="field.classes" :value="field.value"
                                                        :readonly="field.readonly === true"
                                                        @input="field.value = $event.target.value"
                                                        :min="field.min" :max="field.max" :step="field.step">
                                                </template>


                                                <!-- Password field -->
                                                <template x-if="field.type === 'password'">
                                                    <input type="password" :class="field.classes" :value="field.value"
                                                        :readonly="field.readonly === true"
                                                        @input="field.value = $event.target.value">
                                                </template>

                                                <!-- Textarea field -->
                                                <template x-if="field.type === 'textarea'">
                                                    <textarea :class="field.classes" :value="field.value"
                                                        :readonly="field.readonly === true"
                                                        @input="field.value = $event.target.value"></textarea>
                                                </template>

                                                <!-- Switch field -->
                                                <template x-if="field.type === 'switch'">
                                                    <label class="toggle">
                                                        <input type="checkbox" :checked="field.value"
                                                            :disabled="field.readonly === true"
                                                            @change="field.value = $event.target.checked" aria-label="Toggle switch">
                                                        <span class="toggler"></span>
                                                    </label>
                                                </template>

                                                <!-- Range field -->
                                                <template x-if="field.type === 'range'">
                                                    <div class="field-control">
                                                        <input type="range" :min="field.min" :max="field.max"
                                                            :step="field.step" :value="field.value"
                                                            :disabled="field.readonly === true"
                                                            @input="field.value = $event.target.value"
                                                            :class="field.classes">
                                                        <span class="range-value" x-text="field.value"></span>
                                                    </div>
                                                </template>

                                                <!-- Button field -->
                                                <template x-if="field.type === 'button'">
                                                    <button class="btn btn-field" :class="field.classes"
                                                        :disabled="field.readonly === true"
                                                        @click="handleFieldButton(field)" x-text="field.value"></button>
                                                </template>

                                                <!-- Select field -->
                                                <template x-if="field.type === 'select'">
                                                    <select :class="field.classes" x-model="field.value"
                                                        :disabled="field.readonly === true"
                                                        @change="field.id.endsWith('_provider') && settingsModalProxy.handleProviderChange ? settingsModalProxy.handleProviderChange(field.id, field.value) : null">
                                                        <template x-for="option in field.options" :key="option.value">
                                                            <option :value="option.value" x-text="option.label"
                                                                :selected="option.value === field.value"></option>
                                                        </template>
                                                    </select>
                                                </template>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </template>

                            <!-- Tunnel section content - only visible in External Services tab -->
                            <div id="section-tunnel" class="section" x-show="activeTab === 'external'">
                                <div class="section-title">Flare Tunnel</div>
                                <div class="section-description">Create a secure public URL to access your Agent Zero instance anytime, anywhere.</div>
                                <div class="field">
                                    <div class="field-label">
                                        <div class="field-title">Tunnel provider</div>
                                        <div class="field-description">Select provider for public tunnel</div>
                                    </div>
                                    <div class="field-control">
                                        <select id="tunnel-provider" x-model="provider" :disabled="isLoading">
                                            <option value="serveo">Serveo</option>
                                            <option value="cloudflared">Cloudflare</option>
                                        </select>
                                    </div>
                                </div>
                                <div x-data="tunnelSettings">
                                    <div class="tunnel-status" :class="{ 'loading': isLoading, 'stopping': isStopping }">
                                        <template x-if="!linkGenerated && !isLoading && !isStopping">
                                            <div class="tunnel-not-active">
                                                <div class="tunnel-status-text">No tunnel active</div>
                                                <button class="btn btn-primary" @click="generateLink()" :disabled="isLoading">
                                                    Generate Public Link
                                                </button>
                                            </div>
                                        </template>

                                        <template x-if="isLoading && !isStopping">
                                            <div class="tunnel-loading">
                                                <div class="loading-spinner"></div>
                                                <div class="tunnel-status-text" x-text="loadingText || 'Creating tunnel...'"></div>
                                            </div>
                                        </template>

                                        <template x-if="isStopping">
                                            <div class="tunnel-stopping">
                                                <div class="loading-spinner"></div>
                                                <div class="tunnel-status-text">Stopping tunnel...</div>
                                            </div>
                                        </template>

                                        <template x-if="linkGenerated && !isLoading && !isStopping">
                                            <div class="tunnel-active">
                                                <div class="tunnel-status-text">Tunnel active</div>
                                                <div class="tunnel-url-container">
                                                    <input type="text" class="tunnel-url-input" :value="tunnelLink" readonly>
                                                    <button class="btn btn-secondary" @click="copyToClipboard()">Copy</button>
                                                </div>
                                                <div class="tunnel-actions">
                                                    <button class="btn btn-secondary" @click="refreshLink()" :disabled="isStopping">
                                                        Refresh
                                                    </button>
                                                    <button class="btn btn-danger" @click="stopTunnel()" :disabled="isStopping">
                                                        Stop Tunnel
                                                    </button>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Scheduler Tab Content - placeholder for now -->
                        <div x-show="activeTab === 'scheduler'">
                            <div class="scheduler-placeholder">
                                <h3>Task Scheduler</h3>
                                <p>Task scheduler functionality is being implemented.</p>
                            </div>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <div id="buttons-container">
                            <template x-for="button in settings.buttons" :key="button.id">
                                <button :class="button.classes" @click="handleButton(button.id)"
                                    x-text="button.title"></button>
                            </template>
                        </div>
                    </div>
                </div>
            </div>
        </template>
    </div>

    <!-- work_dir Browser Modal -->

    <div id="fileBrowserModal" x-data="fileBrowserModalProxy">
        <template x-teleport="body">
            <div x-show="isOpen" class="modal-overlay" @click.self="handleClose()"
                @keydown.escape.window="handleClose()" x-transition="">
                <div class="modal-container">
                    <div class="modal-header">
                        <h2 class="modal-title" x-text="browser.title"></h2>
                        <button class="modal-close" @click="handleClose()">&times;</button>
                    </div>
                    <div class="modal-content">
                        <div x-show="isLoading" class="loading-spinner">
                            Loading...
                        </div>
                        <div x-show="!isLoading">
                            <div class="path-navigator">
                                <!-- Up Button -->
                                <button class="text-button back-button" @click="navigateUp()" aria-label="Navigate Up">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 10.5 15">
                                        <path d="m.75,5.25L5.25.75m0,0l4.5,4.5M5.25.75v13.5" fill="none"
                                            stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"
                                            stroke-width="1.5"></path>
                                    </svg>
                                    Up
                                </button>

                                <div id="current-path">
                                    <span id="path-text" x-text="browser.currentPath"></span>
                                </div>
                            </div>

                            <div class="files-list">
                                <!-- Header -->
                                <div class="file-header">
                                    <div class="file-cell" @click="toggleSort('name')">
                                        Name
                                        <span x-show="browser.sortBy === 'name'"
                                            x-text="browser.sortDirection === 'asc' ? '‚Üë' : '‚Üì'">
                                        </span>
                                    </div>
                                    <div class="file-cell-size" @click="toggleSort('size')">
                                        Size
                                        <span x-show="browser.sortBy === 'size'"
                                            x-text="browser.sortDirection === 'asc' ? '‚Üë' : '‚Üì'">
                                        </span>
                                    </div>
                                    <div class="file-cell-date" @click="toggleSort('date')">
                                        Modified
                                        <span x-show="browser.sortBy === 'date'"
                                            x-text="browser.sortDirection === 'asc' ? '‚Üë' : '‚Üì'">
                                        </span>
                                    </div>
                                </div>

                                <!-- File List -->
                                <template x-if="browser.entries.length">
                                    <template x-for="file in sortFiles(browser.entries)" :key="file.path">
                                        <div class="file-item" :data-is-dir="file.is_dir">
                                            <div class="file-name"
                                                @click="file.is_dir ? navigateToFolder(file.path) : downloadFile(file)">
                                    <img :src="'/public/' + (file.type === 'unknown' ? 'file' : (isArchive(file.name) ? 'archive' : file.type)) + '.svg'"
                                        class="file-icon" :alt="file.type + ' icon'" width="20" height="20">
                                                <span x-text="file.name"></span>
                                            </div>
                                            <div class="file-size" x-text="formatFileSize(file.size)"></div>
                                            <div class="file-date" x-text="formatDate(file.modified)"></div>

                                            <div class="file-actions">
                                                <button class="action-button download-button"
                                                    @click.stop="downloadFile(file)">
                                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.5 19.5">
                                                        <path
                                                            d="m.75,14.25v2.25c0,1.24,1.01,2.25,2.25,2.25h13.5c1.24,0,2.25-1.01,2.25-2.25v-2.25m-4.5-4.5l-4.5,4.5m0,0l-4.5-4.5m4.5,4.5V.75"
                                                            fill="none" stroke="currentColor" stroke-linecap="round"
                                                            stroke-linejoin="round" stroke-width="1.5"></path>
                                                    </svg>
                                                </button>
                                                <button class="delete-button" @click.stop="deleteFile(file)">
                                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15.03 22.53"
                                                        fill="currentColor">
                                                        <path
                                                            d="m14.55,7.82H4.68L14.09,3.19c.83-.41,1.17-1.42.77-2.25-.41-.83-1.42-1.17-2.25-.77l-3.16,1.55-.15-.31c-.22-.44-.59-.76-1.05-.92-.46-.16-.96-.13-1.39.09l-2.08,1.02c-.9.44-1.28,1.54-.83,2.44l.15.31-3.16,1.55c-.83.41-1.17,1.42-.77,2.25.29.59.89.94,1.51.94.25,0,.5-.06.74-.17l.38-.19s.09.03.14.03h11.14v11.43c0,.76-.62,1.38-1.38,1.38h-.46v-11.28c0-.26-.21-.47-.47-.47s-.47.21-.47.47v11.28h-2.39v-11.28c0-.26-.21-.47-.47-.47s-.47.21-.47.47v11.28h-2.39v-11.28c0-.26-.21-.47-.47-.47s-.47.21-.47.47v11.28h-.46c-.76,0-1.38-.62-1.38-1.38v-9.9c0-.26-.21-.47-.47-.47s-.47.21-.47.47v9.9c0,1.28,1.04,2.32,2.32,2.32h8.55c1.28,0,2.32-1.04,2.32-2.32v-11.91c0-.26-.21-.47-.47-.47ZM5.19,2.46l2.08-1.02c.12-.06.25-.09.39-.09.09,0,.19.02.28.05.22.08.4.23.5.44l.15.31-.19.09-3.46,1.7-.15-.31c-.21-.43-.03-.96.4-1.17Zm-3.19,5.62c-.36.18-.8.03-.98-.33-.18-.36-.03-.8.33-.98l5.8-2.85,2.72-1.34,3.16-1.55c.1-.05.21-.07.32-.07.27,0,.53.15.66.41.09.17.1.37.04.56-.06.18-.19.33-.37.42L2,8.08Z"
                                                            stroke-width="0"></path>
                                                    </svg>
                                                </button>
                                            </div>
                                        </div>
                                    </template>
                                </template>

                                <!-- Empty State -->
                                <template x-if="!browser.entries.length">
                                    <div class="no-files">
                                        No files found
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <div id="file-browser-buttons-container">
                            <label class="btn btn-upload"><svg xmlns="http://www.w3.org/2000/svg" fill="none"
                                    viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5m-13.5-9L12 3m0 0 4.5 4.5M12 3v13.5">
                                    </path>
                                </svg>
                                Upload Files
                                <input type="file" multiple="" accept="all" @change="handleFileUpload"
                                    style="display: none;">
                            </label>
                            <button class="btn btn-cancel" @click="handleClose()">Close Browser</button>
                        </div>
                    </div>
                </div>
            </div>
        </template>
    </div>

    <!-- generic modal -->

    <div id="genericModal" x-data="genericModalProxy">
        <template x-teleport="body">
            <div x-show="isOpen" class="modal-overlay" @click.self="handleClose()"
                @keydown.escape.window="handleClose()" x-transition="">
                <div class="modal-container">
                    <div class="modal-header">
                        <h2 class="modal-title" x-text="title"></h2>
                        <button class="modal-close" @click="handleClose()">&times;</button>
                    </div>
                    <div class="modal-description" x-text="description"></div>
                    <div class="modal-content" id="viewer">
                        <div class="html-pre" x-html="html"></div>
                    </div>
                </div>
            </div>
        </template>
    </div>

    <!-- Full Screen Input Modal -->
    <div id="full-screen-input-modal" x-data="fullScreenInputModalProxy">
        <template x-teleport="body">
            <div x-show="isOpen" class="modal-overlay" @click.self="handleClose()"
                @keydown.escape.window="handleClose()" x-transition="">
                <div class="modal-container full-screen-input-modal">
                    <div class="modal-content">
                        <button class="modal-close" @click="handleClose()">&times;</button>

                        <!-- Add toolbar -->
                        <div class="editor-toolbar">
                            <div class="toolbar-group">
                                <button class="toolbar-button" @click="undo()" :disabled="!canUndo" title="Undo (Ctrl+Z)">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M3 7v6h6"></path>
                                        <path d="M21 17a9 9 0 00-9-9 9 9 0 00-6 2.3L3 13"></path>
                                    </svg>
                                </button>
                                <button class="toolbar-button" @click="redo()" :disabled="!canRedo" title="Redo (Ctrl+Shift+Z)">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M21 7v6h-6"></path>
                                        <path d="M3 17a9 9 0 019-9 9 9 0 016 2.3l3 2.7"></path>
                                    </svg>
                                </button>
                            </div>
                            <div class="toolbar-group">
                                <button class="toolbar-button" @click="clearText()" title="Clear Text">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"></path>
                                        <line x1="10" y1="11" x2="10" y2="17"></line>
                                        <line x1="14" y1="11" x2="14" y2="17"></line>
                                    </svg>
                                </button>
                                <button class="toolbar-button" @click="toggleWrap()" :class="{ active: wordWrap }" title="Toggle Word Wrap">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M3 6h18M3 12h15l3 3-3 3M3 18h18"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>

                        <textarea id="full-screen-input" x-model="inputText"
                            placeholder="Type your message here..."
                            @keydown.ctrl.enter="handleClose()"
                            @keydown.ctrl.z.prevent="undo()"
                            @keydown.ctrl.shift.z.prevent="redo()"
                            :style="{ 'white-space': wordWrap ? 'pre-wrap' : 'pre' }"
                            @input="updateHistory()"></textarea>
                    </div>
                    <div class="modal-footer">
                        <div id="fullscreen-input-buttons-container">
                            <button class="btn btn-ok" @click="handleClose()">Done (Ctrl+Enter)</button>
                        </div>
                    </div>
                </div>
            </div>
        </template>
    </div>

    <!-- Drag and Drop Overlay -->
    <div id="dragdrop-overlay"
         x-cloak
         x-data="{ isVisible: false }"
         x-show="isVisible"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-300"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="dragdrop-overlay">
        <img src="public/dragndrop.svg" alt="Drop files to upload" class="dragdrop-icon">
        <div class="dragdrop-text">Drop files to attach them to your message</div>
        <div class="dragdrop-subtext"></div>
    </div>

    <!-- Footer -->
    <footer style="position: fixed; bottom: 0; right: 0; padding: 0.5rem; font-size: 0.8rem; color: var(--color-muted); background: var(--bg-primary); border-top: 1px solid var(--border-color); z-index: 1000;">
        <a href="/privacy" style="color: var(--color-muted); text-decoration: none; margin-right: 1rem;">Privacy</a>
        <a href="/terms" style="color: var(--color-muted); text-decoration: none;">Terms</a>
    </footer>

    <!-- Enhanced UX initialization -->
    <script>
        // Initialize enhanced UX features when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize chat input validation and character counting using DOM helpers
            const chatInput = window.DOMHelpers?.safeGetElementById('chat-input') || document.getElementById('chat-input');
            const sendButton = window.DOMHelpers?.safeGetElementById('send-button') || document.getElementById('send-button');
            const charCount = window.DOMHelpers?.safeGetElementById('char-count') || document.getElementById('char-count');

            // Validate all required elements exist before proceeding
            if (!chatInput) {
                console.warn('Chat input element not found - skipping chat functionality initialization');
                return;
            }
            if (!sendButton) {
                console.warn('Send button element not found - skipping send functionality initialization');
                return;
            }

            if (chatInput && sendButton) {
                // Enable/disable send button based on input
                function updateSendButton() {
                    // Try multiple ways to get the input value for better compatibility
                    let inputValue = '';
                    try {
                        inputValue = window.DOMHelpers?.safeGetElementValue(chatInput) || chatInput.value || '';
                    } catch (e) {
                        inputValue = chatInput.value || '';
                    }
                    
                    if (typeof inputValue !== 'string') {
                        console.warn('Chat input value is not a string');
                        return;
                    }
                    const isEmpty = !inputValue.trim();
                    sendButton.disabled = isEmpty;
                    sendButton.style.opacity = isEmpty ? '0.5' : '1';
                }

                // Character count display
                function updateCharCount() {
                    // Try multiple ways to get the input value for better compatibility
                    let inputValue = '';
                    try {
                        inputValue = window.DOMHelpers?.safeGetElementValue(chatInput) || chatInput.value || '';
                    } catch (e) {
                        inputValue = chatInput.value || '';
                    }
                    
                    if (typeof inputValue !== 'string') {
                        console.warn('Chat input value is not a string for character count');
                        return;
                    }
                    if (!charCount) {
                        // Character count element is optional, just skip if not found
                        return;
                    }
                    
                    const count = inputValue.length;
                    const maxLength = parseInt(chatInput.getAttribute('maxlength')) || 10000;

                    if (count > maxLength * 0.8) {
                        charCount.textContent = `${count}/${maxLength}`;
                        charCount.style.display = 'block';
                        charCount.style.color = count > maxLength * 0.9 ? 'var(--color-error, #ef4444)' : 'var(--color-warning, #f59e0b)';
                    } else {
                        charCount.style.display = 'none';
                    }
                }

                // Add validation to chat input
                if (window.inputValidator) {
                    const rules = JSON.parse(chatInput.getAttribute('data-validation-rules') || '[]');
                    window.inputValidator.addValidationToElement(chatInput, rules, {
                        showOnInput: true,
                        showOnBlur: false
                    });
                }

                // Event listeners
                chatInput.addEventListener('input', function() {
                    updateSendButton();
                    updateCharCount();
                });

                chatInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        if (!sendButton.disabled) {
                            sendButton.click();
                        }
                    }
                });

                // Initial state
                updateSendButton();
            }

            // Show success message when pages load correctly
            if (window.location.pathname === '/privacy' || window.location.pathname === '/terms') {
                setTimeout(() => {
                    if (window.toastManager) {
                        window.toastManager.show('Legal information loaded successfully', 'success', 3000);
                    }
                }, 500);
            }
        });
    </script>
    <script type="module" src="js/ui-init.js"></script>

</body>

</html>
